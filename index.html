<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VSA Auditor Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-primary: #0a0e27; 
            --bg-card: #1a2352; 
            --accent-blue: #00d4ff; 
            --found-color: #00ff88; 
            --notfound-color: #ff4757; 
            --warning-color: #ffcc00; 
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-primary); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .amazon-logo { width: 110px; margin: 10px 0; filter: brightness(0) invert(1); }
        .main-card { background: var(--bg-card); border-radius: 25px; padding: 25px; width: 92%; max-width: 450px; box-shadow: 0 15px 50px rgba(0,0,0,0.8); text-align: center; transition: all 0.4s ease; }
        
        .dashboard-mini { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; margin-bottom: 25px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .stats-row { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .stat-item { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .divider { width: 2px; height: 50px; background: linear-gradient(to bottom, transparent, var(--accent-blue), transparent); margin: 0 15px; opacity: 0.5; }
        
        #statPendientes { color: var(--notfound-color); font-size: 2.8rem; font-weight: 900; line-height: 1; }
        #statHechas { color: var(--found-color); font-size: 2.8rem; font-weight: 900; line-height: 1; }
        .stat-label { font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; margin-top: 8px; opacity: 0.8; }
        
        .dsp-tags { font-size: 0.95rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .camera-box { display: none; width: 100%; height: 240px; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 15px; border: 2px solid var(--accent-blue); }
        video { width: 100%; height: 100%; object-fit: cover; }
        input[type="text"] { width: 85%; padding: 15px; font-size: 1.4rem; font-weight: 700; text-align: center; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 12px; margin-bottom: 15px; text-transform: uppercase; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; }
        .btn-check { grid-column: span 2; background: white; color: black; font-size: 1rem; }
        .result-card { margin-top: 15px; display: none; padding: 20px; border-radius: 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .card-found { background: var(--found-color) !important; color: #000 !important; }
        .card-not-found { background: var(--notfound-color) !important; color: #fff !important; }
        .card-warn { background: var(--warning-color) !important; color: #000 !important; }
        #auditQuestion { display: none; margin-top: 15px; border-top: 1px solid rgba(0,0,0,0.2); padding-top: 15px; }
    </style>
</head>
<body>

    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" class="amazon-logo">

    <div class="main-card" id="mainCard">
        <div class="dashboard-mini">
            <div class="stats-row">
                <div class="stat-item">
                    <span id="statPendientes">0</span>
                    <span class="stat-label">PENDIENTES</span>
                </div>
                <div class="divider"></div>
                <div class="stat-item">
                    <span id="statHechas">0</span>
                    <span class="stat-label">HECHAS</span>
                </div>
            </div>
            <div class="dsp-tags" id="dspList">Cargando datos...</div>
        </div>

        <div class="camera-box" id="cameraContainer"><video id="video" playsinline></video></div>

        <input type="text" id="manualInput" placeholder="MATRÍCULA">

        <div class="btn-grid">
            <button class="btn" style="background:var(--accent-blue); color:white" onclick="startCamera()">Cámara</button>
            <button class="btn" style="background:#333; color:white" onclick="stopCamera()">Off</button>
            <button class="btn btn-check" id="btnMainVerify" onclick="handleVerify()">VERIFICAR</button>
        </div>

        <div id="resultBox" class="result-card">
            <div id="resMatricula" style="font-weight: 900; font-size: 1.6rem;"></div>
            <div id="resDetails" style="margin: 8px 0; font-size: 1.1rem; font-weight: 700;"></div>
            <div id="auditQuestion">
                <p style="font-weight: 900; margin-bottom: 12px;">¿REALIZAS AUDITORÍA?</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn" style="background:black; color:white" id="btnSi" onclick="confirmAudit()">SÍ</button>
                    <button class="btn" style="background:rgba(0,0,0,0.1); color: black;" onclick="resetUI()">NO</button>
                </div>
            </div>
        </div>
    </div>

<script>
    const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyO8W3F8YhOUAn1Acv7ihChXHbeqz27mjVRqq2fxYLJE42s3yRUYV3ik5s7JQIVbI6z/exec'; 
    let currentDSP = "";
    let currentMatricula = "";
    let colorTimeout;

    window.onload = updateDashboard;

    async function updateDashboard() {
        try {
            const resp = await fetch(SHEETS_URL);
            const data = await resp.json();
            if(data.stats) renderStats(data.stats);
        } catch (e) { console.error("Error Dashboard"); }
    }

    function renderStats(stats) {
        document.getElementById('statHechas').innerText = stats.hechasHoy;
        document.getElementById('statPendientes').innerText = stats.pendientes;
        let html = "";
        for (let dsp in stats.dspStats) {
            html += `<span>${dsp}: <b style="color:var(--accent-blue)">${stats.dspStats[dsp]}</b></span>`;
        }
        document.getElementById('dspList').innerHTML = html || "Sin datos";
    }

    async function handleVerify() {
        const id = document.getElementById('manualInput').value;
        if (!id) return;
        clearTimeout(colorTimeout);
        const idLimpia = id.trim().toUpperCase();
        
        try {
            const resp = await fetch(`${SHEETS_URL}?matricula=${encodeURIComponent(idLimpia)}`);
            const data = await resp.json();
            if(data.stats) renderStats(data.stats);
            
            const mc = document.getElementById('mainCard');
            const rb = document.getElementById('resultBox');
            rb.style.display = 'block';

            if (data.yaAuditada) {
                mc.className = 'main-card card-warn';
                document.getElementById('resMatricula').innerText = "⚠️ YA REGISTRADA";
                document.getElementById('resDetails').innerText = "Furgoneta ya auditada.";
                document.getElementById('auditQuestion').style.display = 'none';
            } else if (data.encontrada) {
                mc.className = 'main-card card-found';
                currentMatricula = data.matricula;
                currentDSP = data.dsp;
                document.getElementById('resMatricula').innerText = "✅ " + data.matricula;
                document.getElementById('resDetails').innerText = "DSP: " + data.dsp;
                document.getElementById('auditQuestion').style.display = 'block';
            } else {
                mc.className = 'main-card card-not-found';
                document.getElementById('resMatricula').innerText = "❌ NO REGISTRADA";
                document.getElementById('auditQuestion').style.display = 'none';
            }
            colorTimeout = setTimeout(resetUI, 5000);
        } catch (e) { alert("Error conexión"); }
    }

    async function confirmAudit() {
        clearTimeout(colorTimeout);
        document.getElementById('btnSi').innerText = "...";
        try {
            const resp = await fetch(`${SHEETS_URL}?registrar=true&matricula=${encodeURIComponent(currentMatricula)}&dsp=${encodeURIComponent(currentDSP)}`);
            const data = await resp.json();
            if(data.stats) renderStats(data.stats);
            resetUI();
            document.getElementById('btnSi').innerText = "SÍ";
        } catch (e) { alert("Error registro"); }
    }

    function resetUI() {
        document.getElementById('mainCard').className = 'main-card';
        document.getElementById('resultBox').style.display = 'none';
        document.getElementById('manualInput').value = "";
    }

    let stream = null;
    async function startCamera() {
        document.getElementById('cameraContainer').style.display = 'block';
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = stream;
        document.getElementById('video').play();
    }
    function stopCamera() {
        document.getElementById('cameraContainer').style.display = 'none';
        if(stream) stream.getTracks().forEach(t => t.stop());
    }
</script>
</body>
</html>
