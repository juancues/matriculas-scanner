<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Verificador VSA - Amazon</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-card: #1a2352;
            --accent-blue: #00d4ff;
            --text-white: #ffffff;
            --found-color: #00ff88; 
            --notfound-color: #ff4757;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-white);
            margin: 0; padding: 5px;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden;
        }

        /* LOGO AMAZON EN BLANCO */
        .amazon-logo {
            width: 100px;
            margin-bottom: 10px;
            filter: brightness(0) invert(1); /* Fuerza el logo a blanco */
        }

        .main-card {
            background: var(--bg-card);
            border-radius: 20px; padding: 15px;
            width: 95%; max-width: 380px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            text-align: center;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .card-found { background: var(--found-color) !important; color: #000 !important; }
        .card-not-found { background: var(--notfound-color) !important; color: #fff !important; }

        .camera-box {
            position: relative; width: 100%; height: 150px;
            background: #000; border-radius: 12px;
            overflow: hidden; margin-bottom: 10px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        video { width: 100%; height: 100%; object-fit: cover; }

        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--accent-blue); display: none;
            animation: scan 1.5s linear infinite; z-index: 5;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        .input-container { width: 70%; margin: 0 auto 10px; }
        input[type="text"] {
            width: 100%; padding: 8px; font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace; text-align: center;
            background: rgba(15, 23, 58, 0.8); border: 1px solid rgba(255,255,255,0.2);
            color: white; border-radius: 8px; text-transform: uppercase;
        }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn {
            padding: 10px; border-radius: 8px; border: none;
            font-weight: 700; cursor: pointer; font-size: 0.7rem;
            text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        
        .btn-start { background: #ffffff; color: #000; } 
        .btn-stop { background: #333; color: white; }
        .btn-check { background: #0a0e27; color: white; grid-column: span 2; }

        .result-card {
            margin-top: 5px; padding: 10px; border-radius: 10px;
            display: none; text-align: left;
            background: rgba(0,0,0,0.15);
        }
        .detail-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.8rem; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .loading { display: none; font-weight: bold; margin: 5px; font-size: 0.75rem; color: var(--accent-blue); }
    </style>
</head>
<body>

    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" alt="Amazon Logo" class="amazon-logo">

    <div class="main-card" id="mainCard">
        <h3 style="margin: 0 0 10px 0; font-size: 1.1rem; font-weight: 900;">VERIFICADOR VSA</h3>

        <div class="camera-box">
            <video id="video" playsinline></video>
            <div class="scan-line" id="scanLine"></div>
        </div>

        <div class="input-container">
            <input type="text" id="manualInput" placeholder="MATRÍCULA">
        </div>

        <div class="btn-grid">
            <button class="btn btn-start" id="btnStart"><i class="fas fa-camera"></i> ENCENDER</button>
            <button class="btn btn-stop" id="btnStop"><i class="fas fa-power-off"></i> APAGAR</button>
            <button class="btn btn-check" id="btnCheckManual"><i class="fas fa-search"></i> VERIFICAR MANUAL</button>
        </div>

        <div id="loader" class="loading">VERIFICANDO...</div>

        <div id="resultBox" class="result-card">
            <div style="text-align:center; font-weight: 900; font-size: 1.1rem;" id="resMatricula"></div>
            <div id="resDetails"></div>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

<script>
    const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyKcyBx4YiXWeFzwFHWAYAwx5HE-gFm7L87a6X81Vq-tdKh6VtUtobwWoEn2UXMMB0A/exec';

    const mainCard = document.getElementById('mainCard');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false }); // Optimización de renderizado
    const scanLine = document.getElementById('scanLine');
    const manualInput = document.getElementById('manualInput');
    const loader = document.getElementById('loader');
    const resultBox = document.getElementById('resultBox');

    let stream = null;
    let scanning = false;
    let lastScanTime = 0;

    window.onload = () => {
        document.getElementById('btnStart').onclick = startCamera;
        document.getElementById('btnStop').onclick = stopCamera;
        document.getElementById('btnCheckManual').onclick = () => checkDatabase(manualInput.value.toUpperCase());
    };

    async function startCamera() {
        try {
            if(stream) stopCamera();
            mainCard.classList.remove('card-found', 'card-not-found');
            resultBox.style.display = 'none';

            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 640 } } // Resolución optimizada
            });
            video.srcObject = stream;
            video.play();
            scanning = true;
            scanLine.style.display = 'block';
            requestAnimationFrame(tick);
        } catch (e) { alert("Error de cámara"); }
    }

    function stopCamera() {
        scanning = false;
        if (stream) { stream.getTracks().forEach(t => t.stop()); video.srcObject = null; }
        scanLine.style.display = 'none';
    }

    function tick() {
        if (scanning && video.readyState === video.HAVE_ENOUGH_DATA) {
            // Escanear cada 100ms para no saturar y ser más rápido
            const now = Date.now();
            if (now - lastScanTime > 100) {
                lastScanTime = now;
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                
                if (code) {
                    manualInput.value = code.data;
                    checkDatabase(code.data);
                    stopCamera();
                    return;
                }
            }
        }
        if (scanning) requestAnimationFrame(tick);
    }

    async function checkDatabase(id) {
        if (!id) return;
        loader.style.display = 'block';
        resultBox.style.display = 'none';
        mainCard.classList.remove('card-found', 'card-not-found');

        try {
            // Fetch optimizado
            const response = await fetch(`${SHEETS_URL}?matricula=${encodeURIComponent(id)}`);
            const data = await response.json();

            resultBox.style.display = 'block';
            if (data.encontrada) {
                mainCard.classList.add('card-found');
                document.getElementById('resMatricula').innerText = "✅ " + data.matricula;
                document.getElementById('resDetails').innerHTML = `
                    <div class="detail-row"><span>PROPIETARIO:</span><b>${data.propietario}</b></div>
                    <div class="detail-row"><span>ESTADO:</span><b>${data.estado}</b></div>
                    <div class="detail-row"><span>NOTAS:</span><b>${data.notas || '-'}</b></div>
                `;
                if(navigator.vibrate) navigator.vibrate(150);
            } else {
                mainCard.classList.add('card-not-found');
                document.getElementById('resMatricula').innerText = "❌ NO REGISTRADO";
                document.getElementById('resDetails').innerHTML = `<p style="text-align:center; font-size:0.8rem;">No existe en sistema.</p>`;
            }
        } catch (e) { console.error("Error base datos"); }
        finally { loader.style.display = 'none'; }
    }
</script>
</body>
</html>
